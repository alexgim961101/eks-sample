###############################################################################
# GitHub Actions Workflow: Terraform CI/CD for EKS
###############################################################################
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” Terraform ì½”ë“œì˜ ë³€ê²½ì‚¬í•­ì„ ìë™ìœ¼ë¡œ ê²€ì¦í•˜ê³  ì ìš©í•©ë‹ˆë‹¤.
#
# ğŸ’¡ í•™ìŠµ í¬ì¸íŠ¸:
# 1. GitHub Actions ê¸°ë³¸ êµ¬ì¡° (on, jobs, steps)
# 2. Environmentë¥¼ í†µí•œ ìˆ˜ë™ ìŠ¹ì¸ ê²Œì´íŠ¸
# 3. OIDCë¥¼ í†µí•œ AWS ì¸ì¦ (ì¥ê¸° ìê²© ì¦ëª… ì—†ì´ ì•ˆì „í•˜ê²Œ)
# 4. Terraform Plan â†’ Apply ì›Œí¬í”Œë¡œìš°
#
# âš ï¸ ì‚¬ì „ ì„¤ì • í•„ìš”:
# 1. GitHub Repository Settings > Environments > "dev" í™˜ê²½ ìƒì„±
# 2. GitHub Repository Settings > Secrets > AWS_ROLE_ARN ì„¤ì •
# 3. AWSì—ì„œ GitHub OIDC Provider ë° IAM Role ìƒì„±
###############################################################################

name: 'Terraform CI/CD'

# íŠ¸ë¦¬ê±° ì¡°ê±´ ì •ì˜
on:
  # main ë¸Œëœì¹˜ì— pushë  ë•Œ
  push:
    branches:
      - main
    paths:
      - 'environments/**'
      - 'modules/**'
      - '.github/workflows/terraform.yml'
  
  # Pull Requestê°€ ì—´ë¦´ ë•Œ
  pull_request:
    branches:
      - main
    paths:
      - 'environments/**'
      - 'modules/**'
  
  # ìˆ˜ë™ ì‹¤í–‰ (Actions íƒ­ì—ì„œ ì§ì ‘ ì‹¤í–‰)
  workflow_dispatch:
    inputs: # ì‚¬ìš©ì ì…ë ¥ ì •ì˜
      environment: # í™˜ê²½ ì„ íƒ
        description: 'Target environment'
        required: true # í•„ìˆ˜ ì…ë ¥
        default: 'dev' # ê¸°ë³¸ê°’
        type: choice # ë“œë¡­ë‹¤ìš´ ë©”ë‰´ë¡œ ì„ íƒ ê°€ëŠ¥
        options: # ì„ íƒ ê°€ëŠ¥í•œ ì˜µì…˜ë“¤
          - dev
          - staging
          - prod
      action: # ì•¡ì…˜ ì„ íƒ
        description: 'Terraform action'
        required: true 
        default: 'plan'
        type: choice
        options:
          - plan
          - apply
          - destroy

# í™˜ê²½ ë³€ìˆ˜ ì •ì˜
env:
  TF_VERSION: '1.5.0'
  AWS_REGION: 'ap-northeast-2'

# ë™ì‹œ ì‹¤í–‰ ì œì–´: ê°™ì€ í™˜ê²½ì— ëŒ€í•œ ë™ì‹œ ë°°í¬ ë°©ì§€
concurrency:
  group: terraform-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

###############################################################################
# Jobs ì •ì˜
###############################################################################
jobs:
  #############################################################################
  # Job 1: Terraform Format & Validate
  #############################################################################
  # ğŸ’¡ í•™ìŠµ í¬ì¸íŠ¸:
  # - terraform fmt: ì½”ë“œ ìŠ¤íƒ€ì¼ ì¼ê´€ì„± ê²€ì‚¬
  # - terraform validate: êµ¬ë¬¸ ì˜¤ë¥˜ ë° ì„¤ì • ê²€ì‚¬
  #############################################################################
  validate:
    name: 'Validate Terraform'
    runs-on: ubuntu-latest
    
    # ê¶Œí•œ ì„¤ì • (OIDC ì¸ì¦ì— í•„ìš”)
    permissions:
      contents: read
      id-token: write  # OIDC í† í° ë°œê¸‰ì— í•„ìš”
    
    steps:
      # Step 1: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      # Step 2: Terraform ì„¤ì¹˜
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      # Step 3: Terraform í¬ë§· ê²€ì‚¬
      # -check: í¬ë§·ì´ ë§ì§€ ì•Šìœ¼ë©´ ì—ëŸ¬ ë°˜í™˜ (ìˆ˜ì •í•˜ì§€ ì•ŠìŒ)
      # -recursive: í•˜ìœ„ ë””ë ‰í† ë¦¬ê¹Œì§€ ê²€ì‚¬
      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true
      
      # Step 4: AWS ìê²© ì¦ëª… (OIDC)
      # ğŸ’¡ í•™ìŠµ í¬ì¸íŠ¸:
      # - OIDCë¥¼ ì‚¬ìš©í•˜ë©´ ì¥ê¸° Access Key ì—†ì´ AWS ì¸ì¦ ê°€ëŠ¥
      # - GitHubê°€ JWT í† í°ì„ ë°œê¸‰í•˜ê³ , AWSê°€ ì´ë¥¼ ê²€ì¦
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-terraform
          aws-region: ${{ env.AWS_REGION }}
      
      # Step 5: Terraform ì´ˆê¸°í™”
      - name: Terraform Init
        id: init
        working-directory: environments/${{ github.event.inputs.environment || 'dev' }}
        run: terraform init -input=false
      
      # Step 6: Terraform ìœ íš¨ì„± ê²€ì‚¬
      - name: Terraform Validate
        id: validate
        working-directory: environments/${{ github.event.inputs.environment || 'dev' }}
        run: terraform validate -no-color
      
      # Step 7: PRì— ê²€ì¦ ê²°ê³¼ ì½”ë©˜íŠ¸ (PRì¸ ê²½ìš°ë§Œ)
      - name: Post Validation Results to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `### Terraform Validation Results ğŸ”
            
            #### Format Check ğŸ–Œï¸: \`${{ steps.fmt.outcome }}\`
            #### Initialization âš™ï¸: \`${{ steps.init.outcome }}\`
            #### Validation ğŸ¤–: \`${{ steps.validate.outcome }}\`
            
            *Pushed by: @${{ github.actor }}, Action: \`${{ github.event_name }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  #############################################################################
  # Job 2: Terraform Plan
  #############################################################################
  # ğŸ’¡ í•™ìŠµ í¬ì¸íŠ¸:
  # - terraform plan: ë³€ê²½ì‚¬í•­ì„ ë¯¸ë¦¬ë³´ê¸° (ì‹¤ì œ ì ìš© ì—†ìŒ)
  # - Plan ê²°ê³¼ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì €ì¥í•˜ì—¬ Applyì—ì„œ ì¬ì‚¬ìš©
  #############################################################################
  plan:
    name: 'Terraform Plan'
    runs-on: ubuntu-latest
    needs: validate  # validate jobì´ ì„±ê³µí•´ì•¼ ì‹¤í–‰
    
    # Planì´ í•„ìš”í•œ ì¡°ê±´:
    # 1. PRì¸ ê²½ìš° (ë¦¬ë·°ìš©)
    # 2. workflow_dispatchë¡œ ì‹¤í–‰í•œ ê²½ìš°
    # 3. mainì— pushëœ ê²½ìš°
    if: |
      github.event_name == 'pull_request' ||
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main')
    
    permissions:
      contents: read
      id-token: write
      pull-requests: write  # PRì— ì½”ë©˜íŠ¸ ì‘ì„±ìš©
    
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-terraform
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Terraform Init
        working-directory: environments/${{ github.event.inputs.environment || 'dev' }}
        run: terraform init -input=false
      
      # Terraform Plan ì‹¤í–‰
      # -out: Plan ê²°ê³¼ë¥¼ íŒŒì¼ë¡œ ì €ì¥ (Applyì—ì„œ ì‚¬ìš©)
      # -detailed-exitcode: ë³€ê²½ì‚¬í•­ ìœ ë¬´ì— ë”°ë¼ ë‹¤ë¥¸ exit code ë°˜í™˜
      #   0 = ë³€ê²½ ì—†ìŒ, 1 = ì—ëŸ¬, 2 = ë³€ê²½ ìˆìŒ
      - name: Terraform Plan
        id: plan
        working-directory: environments/${{ github.event.inputs.environment || 'dev' }}
        run: |
          terraform plan -input=false -no-color -out=tfplan \
            -detailed-exitcode 2>&1 | tee plan_output.txt
          echo "exitcode=${PIPESTATUS[0]}" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      # Plan ê²°ê³¼ë¥¼ ì•„í‹°íŒ©íŠ¸ë¡œ ì €ì¥
      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.environment || 'dev' }}
          path: |
            environments/${{ github.event.inputs.environment || 'dev' }}/tfplan
            environments/${{ github.event.inputs.environment || 'dev' }}/plan_output.txt
          retention-days: 5
      
      # PRì— Plan ê²°ê³¼ ì½”ë©˜íŠ¸
      - name: Post Plan to PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const planOutput = fs.readFileSync(
              `environments/${{ github.event.inputs.environment || 'dev' }}/plan_output.txt`,
              'utf8'
            );
            
            // Plan ì¶œë ¥ì´ ë„ˆë¬´ ê¸¸ë©´ ìë¥´ê¸°
            const maxLength = 60000;
            const truncated = planOutput.length > maxLength 
              ? planOutput.substring(0, maxLength) + '\n\n... (truncated)'
              : planOutput;
            
            const output = `### Terraform Plan ğŸ“–
            
            <details>
            <summary>Click to expand Plan output</summary>
            
            \`\`\`terraform
            ${truncated}
            \`\`\`
            
            </details>
            
            *Plan generated for environment: \`${{ github.event.inputs.environment || 'dev' }}\`*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
      
      # Planì´ ì‹¤íŒ¨í•˜ë©´ ì›Œí¬í”Œë¡œìš° ì‹¤íŒ¨
      - name: Check Plan Status
        if: steps.plan.outputs.exitcode == '1'
        run: exit 1

  #############################################################################
  # Job 3: Terraform Apply
  #############################################################################
  # ğŸ’¡ í•™ìŠµ í¬ì¸íŠ¸:
  # - Environmentë¥¼ í†µí•œ ìˆ˜ë™ ìŠ¹ì¸ ê²Œì´íŠ¸
  # - Plan ê²°ê³¼ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì •í™•íˆ ê°™ì€ ë³€ê²½ì‚¬í•­ ì ìš©
  # - destroy ì˜µì…˜ìœ¼ë¡œ ë¦¬ì†ŒìŠ¤ ì‚­ì œë„ ê°€ëŠ¥
  #############################################################################
  apply:
    name: 'Terraform Apply'
    runs-on: ubuntu-latest
    needs: plan
    
    # Apply ì¡°ê±´:
    # 1. workflow_dispatchë¡œ ì‹¤í–‰í•˜ê³  actionì´ apply ë˜ëŠ” destroyì¸ ê²½ìš°
    # 2. mainì— pushë˜ê³  planì— ë³€ê²½ì‚¬í•­ì´ ìˆëŠ” ê²½ìš° (exitcode=2)
    if: |
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.action == 'apply' || github.event.inputs.action == 'destroy')) ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main' && 
       needs.plan.outputs.plan_exitcode == '2')
    
    # ğŸ’¡ Environment ì„¤ì •
    # GitHub Repository Settings > Environmentsì—ì„œ ë³´í˜¸ ê·œì¹™ ì„¤ì • ê°€ëŠ¥:
    # - Required reviewers: íŠ¹ì • ì‚¬ìš©ìì˜ ìŠ¹ì¸ í•„ìš”
    # - Wait timer: ì§€ì •ëœ ì‹œê°„ ëŒ€ê¸° í›„ ìë™ ì§„í–‰
    environment: ${{ github.event.inputs.environment || 'dev' }}
    
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: github-actions-terraform
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Terraform Init
        working-directory: environments/${{ github.event.inputs.environment || 'dev' }}
        run: terraform init -input=false
      
      # Plan ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: Download Plan Artifact
        if: github.event.inputs.action != 'destroy'
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ github.event.inputs.environment || 'dev' }}
          path: environments/${{ github.event.inputs.environment || 'dev' }}
      
      # Terraform Apply (Plan íŒŒì¼ ì‚¬ìš©)
      # ğŸ’¡ ì €ì¥ëœ Plan íŒŒì¼ì„ ì‚¬ìš©í•˜ë©´ Plan ì‹œì ì˜ ì •í™•í•œ ë³€ê²½ì‚¬í•­ë§Œ ì ìš©ë¨
      - name: Terraform Apply
        if: github.event.inputs.action != 'destroy'
        working-directory: environments/${{ github.event.inputs.environment || 'dev' }}
        run: terraform apply -auto-approve -input=false tfplan
      
      # Terraform Destroy (ë¦¬ì†ŒìŠ¤ ì‚­ì œ)
      # âš ï¸ ì£¼ì˜: ëª¨ë“  ë¦¬ì†ŒìŠ¤ê°€ ì‚­ì œë©ë‹ˆë‹¤!
      - name: Terraform Destroy
        if: github.event.inputs.action == 'destroy'
        working-directory: environments/${{ github.event.inputs.environment || 'dev' }}
        run: terraform destroy -auto-approve -input=false

  #############################################################################
  # Job 4: Post-Apply Notification
  #############################################################################
  # ğŸ’¡ í•™ìŠµ í¬ì¸íŠ¸:
  # - Slack/Email ë“±ìœ¼ë¡œ ë°°í¬ ê²°ê³¼ ì•Œë¦¼
  # - ì„±ê³µ/ì‹¤íŒ¨ì— ë”°ë¥¸ ë¶„ê¸° ì²˜ë¦¬
  #############################################################################
  notify:
    name: 'Send Notification'
    runs-on: ubuntu-latest
    needs: [plan, apply]
    if: always() && (needs.apply.result == 'success' || needs.apply.result == 'failure')
    
    steps:
      # ì„±ê³µ ì•Œë¦¼
      - name: Notify Success
        if: needs.apply.result == 'success'
        run: |
          echo "âœ… Terraform Apply succeeded!"
          echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "Action: ${{ github.event.inputs.action || 'apply' }}"
          echo "Actor: ${{ github.actor }}"
          # ì—¬ê¸°ì— Slack/Email ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥
          # ì˜ˆ: curl -X POST -H 'Content-type: application/json' \
          #     --data '{"text":"Terraform Apply ì„±ê³µ!"}' \
          #     ${{ secrets.SLACK_WEBHOOK_URL }}
      
      # ì‹¤íŒ¨ ì•Œë¦¼
      - name: Notify Failure
        if: needs.apply.result == 'failure'
        run: |
          echo "âŒ Terraform Apply failed!"
          echo "Environment: ${{ github.event.inputs.environment || 'dev' }}"
          echo "Please check the workflow logs for details."
          # ì—¬ê¸°ì— ì‹¤íŒ¨ ì•Œë¦¼ ì¶”ê°€ ê°€ëŠ¥
